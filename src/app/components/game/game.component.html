<div *ngIf="game && user" class="w-100 p-2" id="div-game">
  <app-user *ngIf="user.created.toMillis() === user.modified.toMillis()"></app-user>
  <div *ngIf="user.created.toMillis() !== user.modified.toMillis()">
     <!-- Admin Action Buttons  -->
     <div *ngIf="game.adminId === user.id" class="d-flex justify-content-between mt-2">
      <button
        class="btn btn-primary"
        (click)="restart()"
      >
        <i class="bi bi-arrow-clockwise"></i>
        <span class="ms-2" [innerText]="languagePack[language]['restart']"></span>
      </button>
      <button class="btn btn-danger" (click)="deleteGame(game)">
        <i class="bi bi-trash"></i>
        <span class="ms-2" [innerText]="languagePack[language]['delete']" ></span>
      </button>
    </div>
    <!-- Waiting -->
    <div *ngIf="game.status === GameStatus.Waiting">
      <!-- Waiting Info -->
      <div *ngIf="readyUserCount !== game.players.length" class="alert alert-info" role="alert" [innerText]="languagePack[language]['waiting-for-players']"></div>
      <div *ngIf="readyUserCount === game.players.length" class="alert alert-success" role="alert" [innerText]="languagePack[language]['waiting-for-admin-to-start']"></div>
      <div *ngIf="game.name === GameName.Majority && game.players.length <= game.config.target" class="alert alert-danger" role="alert" [innerText]="languagePack[language]['player-not-enough']"></div>
      <!-- Game Description -->
      <h2 [innerText]="languagePack[language]['how-to-play']"></h2>
      <div class="d-flex justify-content-start mt-2" >
        <!-- Game: Countdown -->
        <p *ngIf="game.name === GameName.CountDown" [innerText]="languagePack[language]['countdown-desc-1'] + ' ' + game.config.target + ' ' + languagePack[language]['countdown-desc-2']"></p>
        <!-- Game: Majority -->
        <p *ngIf="game.name === GameName.Majority" [innerText]="languagePack[language]['majority-desc-1'] + ' ' + game.config.target + ' ' + languagePack[language]['majority-desc-2']"></p>
      </div>
      <!-- Players  -->
      <h2 class="mt-2" [innerText]="languagePack[language]['players'] + '   ' + readyUserCount +  '/' + game.players.length"></h2>
      <!-- Action Buttons  -->
      <div class="d-flex justify-content-between mt-2">
        <button class="btn btn-success" (click)="sendInvitation(game)">
          <i class="bi bi-share"></i>
          <span class="ms-2" [innerText]="languagePack[language]['send-invitation']"></span>
        </button>
        <button
          *ngIf="!isReady"
          class="btn btn-success"
          (click)="ready()"
        >
          <i class="bi bi-check-lg"></i>
          <span class="ms-2" [innerText]="languagePack[language]['ready']"></span>
        </button>
        <button
          *ngIf="isReady && game.adminId === user.id"
          class="btn btn-primary"
          (click)="start()"
          [disabled]="
            readyUserCount !== game.players.length
            || (game.name === GameName.Majority && game.players.length <= game.config.target)
          "
        >
          <i class="bi bi-play"></i>
          <span class="ms-2" [innerText]="languagePack[language]['start']"></span>
        </button>
      </div>
      <!-- Players -->
      <div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 px-2 mt-2">
        <div
          *ngFor="let player of game.players"
          class="border border-2 p-2 rounded m-1 player align-items-center d-flex"
          [class.border-success]="player.ready"
        >
          <img alt="user-icon" class="rounded-circle user-icon" [src]="player.imgUrl">
          <span class="ms-2 text-truncate d-inline-block" [innerText]="player.id===user.id? languagePack[language]['you'] : player.name"></span>
        </div>
      </div>
    </div>

    <!-- Color Challenge Game UI -->
    <div *ngIf="game.name === GameName.COLOR_CHALLENGE" class="color-challenge-container">
      <ng-container [ngSwitch]="game.status">

        <!-- WAITING State for Color Challenge -->
        <div *ngSwitchCase="GameStatus.Waiting">
          <!-- Re-use existing waiting room structure; only customize description -->
          <div *ngIf="readyUserCount !== game.players.length" class="alert alert-info" role="alert" [innerText]="languagePack[language]['waiting-for-players']"></div>
          <div *ngIf="readyUserCount === game.players.length && game.adminId !== user.id" class="alert alert-success" role="alert" [innerText]="languagePack[language]['waiting-for-admin-to-start']"></div>
          <div *ngIf="readyUserCount === game.players.length && game.adminId === user.id" class="alert alert-success" role="alert">{{ languagePack[language]['all-players-ready-admin-start'] || 'All players ready. Admin can start the game!' }}</div>
          
          <!-- Game Description -->
          <h2 [innerText]="languagePack[language]['how-to-play']"></h2>
          <p [innerText]="languagePack[language]['color-challenge-description-1'] || 'Quickly identify the color or text that matches the instruction. The player with the highest score wins.'"></p>
          <p><strong>{{ languagePack[language]['color-challenge-rounds'] || 'Rounds' }}:</strong> {{ game.config.rounds }}</p>
          <p><strong>{{ languagePack[language]['color-challenge-time-limit-per-round'] || 'Time Limit Per Round' }}:</strong> {{ game.config.timeLimitPerRound }}s</p>

          <!-- Players List (re-use existing) -->
          <h2 class="mt-2" [innerText]="languagePack[language]['players'] + '   ' + readyUserCount +  '/' + game.players.length"></h2>
          <div class="d-flex justify-content-between mt-2">
            <button class="btn btn-success" (click)="sendInvitation(game)">
              <i class="bi bi-share"></i>
              <span class="ms-2" [innerText]="languagePack[language]['send-invitation']"></span>
            </button>
            <button *ngIf="!isReady" class="btn btn-success" (click)="ready()">
              <i class="bi bi-check-lg"></i>
              <span class="ms-2" [innerText]="languagePack[language]['ready']"></span>
            </button>
            <button
              *ngIf="isReady && game.adminId === user.id"
              class="btn btn-primary"
              (click)="start()"
              [disabled]="readyUserCount !== game.players.length"
            >
              <i class="bi bi-play"></i>
              <span class="ms-2" [innerText]="languagePack[language]['start']"></span>
            </button>
          </div>
          <div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 px-2 mt-2">
            <div
              *ngFor="let player of game.players"
              class="border border-2 p-2 rounded m-1 player align-items-center d-flex"
              [class.border-success]="player.ready"
            >
              <img alt="user-icon" class="rounded-circle user-icon" [src]="player.imgUrl">
              <span class="ms-2 text-truncate d-inline-block" [innerText]="player.id===user.id? languagePack[language]['you'] : player.name"></span>
            </div>
          </div>
        </div>

        <!-- PLAYING State for Color Challenge -->
        <div *ngSwitchCase="GameStatus.Playing" class="text-center">
          <div class="my-3">
            <h4 [innerText]="languagePack[language]['round'] + ' ' + game.round + ' / ' + game.config.rounds"></h4>
          </div>
          <div class="cc-instruction my-3 fs-5">
            {{ languagePack[language][currentInstructionType === InstructionType.TextColor ? 'instructionTextColor' : 'instructionTextMeaning'] }}
          </div>
          <div class="cc-challenge-text my-4" [style.color]="textColor">
            {{ textToDisplay }}
          </div>
          <div class="cc-timer my-3 fs-4">
            {{ languagePack[language]['time-remaining'] || 'Time' }}: {{ roundTimeRemaining }}s
          </div>
          <div class="cc-options-grid my-3">
            <button
              *ngFor="let colorCss of colorOptions"
              class="btn cc-color-option m-2"
              [style.background-color]="colorCss"
              (click)="logPlayerResult(colorCss)"
              [disabled]="playerRoundData.has(user.id) || roundTimeRemaining <= 0"
            >
              <span class="cc-button-text">{{ languagePack[language]['color_' + getColorKeyForLang(colorCss)] || getDisplayNameForCss(colorCss) }}</span>
            </button>
          </div>
           <div *ngIf="playerRoundData.has(user.id)" class="alert alert-info mt-3">
            {{ languagePack[language]['cc-you-answered'] || 'You have answered! Waiting for other players...' }}
          </div>
        </div>

        <!-- CALCULATING State for Color Challenge -->
        <div *ngSwitchCase="GameStatus.Calculating" class="text-center">
          <h3 class="my-3">{{ languagePack[language]['calculating-results'] || 'Calculating Results...' }}</h3>
          <div *ngIf="correctAnswer" class="my-3 fs-5">
            {{ languagePack[language]['correctAnswerWas'] }}
            <span class="fw-bold" [style.color]="correctAnswer">{{ getDisplayNameForCss(correctAnswer) }}</span>
          </div>
          
          <div class="list-group my-3">
            <div *ngFor="let p of game.players" class="list-group-item">
              <div class="d-flex w-100 justify-content-between">
                <h5 class="mb-1">{{ p.id === user.id ? languagePack[language]['you'] : p.name }}</h5>
                <small *ngIf="playerRoundData.get(p.id) as roundInfo">
                  <span *ngIf="roundInfo.correct" class="badge bg-success">{{ languagePack[language]['correct'] || 'Correct' }}</span>
                  <span *ngIf="!roundInfo.correct" class="badge bg-danger">{{ languagePack[language]['incorrect'] || 'Incorrect' }}</span>
                </small>
              </div>
              <p class="mb-1" *ngIf="playerRoundData.get(p.id) as roundInfo">
                {{ languagePack[language]['yourChoice'] }}
                <span class="fw-bold" [style.color]="roundInfo.choice">{{ getDisplayNameForCss(roundInfo.choice) }}</span>
                ({{ languagePack[language]['cc-time-remaining'] || 'Time left' }}: {{roundInfo.time}}s)
              </p>
               <p class="mb-1" *ngIf="!playerRoundData.get(p.id)">
                {{ languagePack[language]['cc-no-answer'] || 'No answer submitted.' }}
              </p>
            </div>
          </div>

          <div *ngIf="game.adminId === user.id && game.round <= game.config.rounds" class="my-3">
            <button class="btn btn-primary" (click)="proceedToNextRoundOrFinish()">
              {{ game.round < game.config.rounds ? (languagePack[language]['next-round'] || 'Next Round') : (languagePack[language]['show-final-results'] || 'Show Final Results') }}
            </button>
          </div>
           <div *ngIf="game.adminId !== user.id" class="alert alert-info">
             {{ languagePack[language]['waiting-for-admin-to-proceed'] || 'Waiting for admin to proceed...'}}
           </div>
        </div>

        <!-- FINISHED State for Color Challenge -->
        <div *ngSwitchCase="GameStatus.Finished">
          <h2 [innerText]="languagePack[language]['results']" class="mt-2"></h2>
          <div class="list-group">
            <div *ngFor="let res of playerResult; let i = index" class="list-group-item d-flex justify-content-between align-items-center">
              <div>
                <img alt="user-icon" class="rounded-circle user-icon me-2" [src]="res.player.imgUrl">
                <strong class="me-2">{{ i + 1 }}. {{ res.player.id === user.id ? languagePack[language]['you'] : res.player.name }}</strong>
              </div>
              <span class="badge bg-primary rounded-pill fs-6">{{ res.score }} {{ languagePack[language]['points'] || 'Points' }}</span>
            </div>
          </div>
          <!-- Admin buttons for restart/delete are already at the top level -->
        </div>
      </ng-container>
    </div>

    <!-- Playing (Original for Countdown and Majority) -->
    <div *ngIf="game.status === GameStatus.Playing && game.name !== GameName.COLOR_CHALLENGE">
      <!-- Game: Countdown -->
      <div *ngIf="game.name === GameName.CountDown">
        <!-- Countdown Number -->
        <div class="d-flex justify-content-center">
          <span
            class="count"
            [innerText]="count | number: '1.2-2'"
            [style.opacity] = "1 - count / (game.config.target * 0.2)"
            [class.opacity-0]="isLogged"
          ></span>
        </div>
        <!-- Game Description -->
        <div class="d-flex justify-content-center mt-2">
          <p [innerText]="languagePack[language]['countdown-desc-1'] + ' ' + game.config.target + ' ' + languagePack[language]['countdown-desc-2']"></p>
        </div>
        <!-- Log Result -->
        <div class="d-flex justify-content-center mt-2" *ngIf="!isLogged">
          <button class="btn btn-lg btn-primary" (click)="logPlayerResult()">
            <i class="bi bi-stopwatch"></i>
          </button>
        </div>
        <!-- Other Player Info -->
        <div
          *ngIf="isLogged"
          class="alert alert-info mt-2"
          role="alert"
          [innerText]="languagePack[language]['wait-for-other-player-done'] + ' (' + game.results.length + '/' + game.players.length + ')'"
        ></div>
      </div>
      <!-- Game: Majority -->
      <div *ngIf="game.name === GameName.Majority">
        <!-- Round -->
        <div class="d-flex justify-content-center">
          <h2 [innerText]="languagePack[language]['round-desc-1'] + game.round + languagePack[language]['round-desc-2']"></h2>
        </div>
        <div class="d-flex justify-content-between">
          <div class="w-50 m-1">
            <button id="button-left" class="btn btn-success w-100 border-2" style="height: 10rem;" (click)="logPlayerResult('left')" [disabled]="isLogged || !isRemain" [class.border-black]="side===Side.Left"> </button>
          </div>
          <div class="w-50 m-1">
            <button id="button-right" class="btn btn-danger w-100 border-2" style="height: 10rem;" (click)="logPlayerResult('right')" [disabled]="isLogged || !isRemain" [class.border-black]="side===Side.Right"> </button>
          </div>
        </div>
        <!-- Other Player Info -->
        <div
          *ngIf="isLogged || !isRemain"
          class="alert alert-info mt-2"
          role="alert"
          [innerText]="languagePack[language]['wait-for-other-player-done'] + ' (' + loggedPlayerCount + '/' + remainPlayerCount + ')'"
        ></div>
      </div>
    </div>
    <!-- Calculating -->
    <div *ngIf="game.status === GameStatus.Calculating">
      <!-- Game: Majority -->
      <div *ngIf="game.name === GameName.Majority">
        <!-- Next Round -->
        <div class="alert alert-info" role="alert" [innerText]="languagePack[language]['waiting-for-next-round-start']"></div><!-- Action Buttons  -->
        <div class="d-flex justify-content-end mt-2">
          <button *ngIf="game.adminId === user.id" [innerText]="languagePack[language]['next-round']" class="btn btn-primary" (click)="nextRound()"></button>
        </div>
        <!-- Round -->
        <div class="d-flex justify-content-center">
          <h2 [innerText]="languagePack[language]['round-desc-1'] + game.round + languagePack[language]['round-desc-2']"></h2>
        </div>
        <!-- Result -->
        <div class="d-flex justify-content-between">
          <div class="w-50 m-1">
            <button id="button-left" class="btn btn-success w-100 border-2 fs-1" style="height: 10rem;" [innerText]="leftCount"></button>
            <div *ngFor="let playerResult of game.results;">
              <div
                *ngIf="playerResult.side === Side.Left && playerResult.round === game.round"
                class="border border-2 p-2 rounded my-1 player d-flex justify-content-between align-items-center w-100"
              >
                <div class="d-flex justify-content-between align-items-center">
                  <img alt="user-icon" class="rounded-circle user-icon" [src]="playerResult.player.imgUrl">
                  <span class="ms-2 text-truncate d-inline-block" [innerText]="playerResult.player.id===user.id? languagePack[language]['you'] : playerResult.player.name"></span>
                </div>
              </div>
            </div>
          </div>
          <div class="w-50 m-1">
            <button id="button-right" class="btn btn-danger w-100 border-2 fs-1" style="height: 10rem;" [innerText]="rightCount"></button>
            <div *ngFor="let playerResult of game.results;">
              <div
                *ngIf="playerResult.side === Side.Right && playerResult.round === game.round"
                class="border border-2 p-2 rounded my-1 player d-flex justify-content-between align-items-center w-100"
              >
                <div class="d-flex justify-content-between align-items-center">
                  <img alt="user-icon" class="rounded-circle user-icon" [src]="playerResult.player.imgUrl">
                  <span class="ms-2 text-truncate d-inline-block" [innerText]="playerResult.player.id===user.id? languagePack[language]['you'] : playerResult.player.name"></span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <!-- Finished -->
    <div *ngIf="game.status === GameStatus.Finished">
      <!-- Results -->
      <h2 [innerText]="languagePack[language]['results']" class="mt-2"></h2>
      <!-- Player Result -->
      <div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 px-2 mt-2">
        <!-- Game: Countdown -->
        <div *ngIf="game.name === GameName.CountDown">
          <div
            *ngFor="let playerResult of playerResult"
            class="border border-2 p-2 rounded m-1 player d-flex justify-content-between align-items-center w-75"
          >
            <div class="d-flex justify-content-between align-items-center">
              <img alt="user-icon" class="rounded-circle user-icon" [src]="playerResult.player.imgUrl">
              <span class="ms-2 text-truncate d-inline-block" [innerText]="playerResult.player.id===user.id? languagePack[language]['you'] : playerResult.player.name"></span>
            </div>
            <div class="d-flex justify-content-between align-items-center">
              <span class="ms-2 d-inline-block" [innerText]="playerResult.value  | number: '1.2-2' "></span>
              <span
                class="ms-2 d-inline-block"
                *ngIf="playerResult.value"
                [class.text-success]="playerResult.value >= game.config.target"
                [class.text-danger]="playerResult.value < game.config.target"
                [innerText]="'(' + (playerResult.value >= game.config.target? '+' : '') + ((playerResult.value - game.config.target)  | number: '1.2-2')  + ')'"></span>
            </div>
          </div>
        </div>
        <!-- Game: Majority -->
        <div *ngIf="game.name === GameName.Majority">
          <div
            *ngFor="let playerResult of playerResult; let i = index"
            class="border border-2 p-2 rounded m-1 player d-flex justify-content-between align-items-center w-75"
            [class.border-success]="playerResult.round === (game.round! + 1)"
          >
            <div class="d-flex justify-content-between align-items-center">
              <img alt="user-icon" class="rounded-circle user-icon" [src]="playerResult.player.imgUrl">
              <span class="ms-2 text-truncate d-inline-block" [innerText]="playerResult.player.id===user.id? languagePack[language]['you'] : playerResult.player.name"></span>
            </div>
            <div class="d-flex justify-content-between align-items-center">
              <span class="ms-2 d-inline-block" [innerText]="languagePack[language]['round-desc-1'] + playerResult.round + languagePack[language]['round-desc-2']"></span>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
